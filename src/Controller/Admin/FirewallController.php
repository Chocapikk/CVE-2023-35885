<?php
 namespace App\Controller\Admin; use Symfony\Component\HttpFoundation\Request; use Symfony\Component\HttpFoundation\Response; use Symfony\Component\Form\Extension\Core\Type\SubmitType; use Symfony\Component\Form\Form; use App\Controller\Controller; use App\Event\EventQueue; use App\Entity\Manager\FirewallRuleManager; use App\Entity\FirewallRule; use App\Ufw\Firewall as UfwFirewall; class FirewallController extends Controller { public function index(Request $request, FirewallRuleManager $firewallRuleManager) : Response { goto bb9ff; bb9ff: $rules = $firewallRuleManager->findAll([], ["\160\x6f\162\164\x52\141\156\x67\x65" => "\141\163\143"]); goto f472b; B0205: return $response; goto aebc7; f472b: $response = $this->render("\101\x64\155\x69\156\x2f\x53\145\143\x75\162\151\164\x79\57\x46\x69\162\145\x77\x61\154\154\x2f\x69\x6e\144\x65\170\x2e\150\164\x6d\x6c\56\164\x77\151\x67", ["\x72\165\x6c\145\163" => $rules]); goto B0205; aebc7: } public function addRule(Request $request, FirewallRuleManager $firewallRuleManager) : Response { goto af03f; a3faa: if (!(true === $request->isMethod("\120\x4f\x53\x54"))) { goto a736c; } goto f5009; e3626: if (!(false === is_null($response))) { goto Abebf; } goto dbe2d; afdf7: c084a: goto D6033; bc072: return $response; goto e7454; Cd14f: Abebf: goto afdf7; C1935: $form = $this->createFirewallRuleForm($firewallRule); goto a3faa; af03f: $firewallRule = $firewallRuleManager->createEntity(); goto C1935; c7bfb: $response = $this->render("\101\x64\155\x69\x6e\57\x53\x65\x63\165\162\151\x74\x79\x2f\106\x69\x72\x65\167\x61\x6c\154\57\141\x64\x64\55\162\x75\154\145\x2e\x68\164\x6d\x6c\56\x74\167\151\147", ["\146\x6f\x72\155" => $form->createView(), "\146\x6f\162\155\x45\162\x72\157\162\x73" => $this->formErrors]); goto bc072; D6033: a736c: goto c7bfb; Acf78: $response = $this->handleFirewallRuleForm($request, $form, $firewallRuleManager); goto e3626; f5009: $form->handleRequest($request); goto e47a7; e47a7: if (!(true === $form->isSubmitted())) { goto c084a; } goto Acf78; dbe2d: return $response; goto Cd14f; e7454: } private function createFirewallRuleForm(FirewallRule $firewallRule) : Form { goto Edba0; Edba0: $form = $this->createForm("\101\x70\160\x5c\x46\x6f\162\x6d\x5c\x41\144\x6d\151\156\x46\151\x72\x65\167\141\154\x6c\x52\165\154\x65\x41\x64\x64\124\171\x70\x65", $firewallRule, ["\x61\x63\x74\x69\157\x6e" => $this->generateUrl("\x63\x6c\160\137\x61\144\x6d\x69\x6e\x5f\146\x69\x72\x65\x77\x61\154\154\x5f\162\165\x6c\x65\137\x61\144\144"), "\155\145\x74\x68\x6f\144" => "\x50\x4f\123\124", "\141\164\x74\x72" => []]); goto b2b5b; A13a7: return $form; goto e7771; b2b5b: $form->add("\x73\165\142\155\151\x74", SubmitType::class, ["\141\164\x74\x72" => ["\143\154\x61\163\163" => "\142\164\x6e\x20\142\164\x6e\x2d\x62\x6c\x75\x65\40\142\164\156\x2d\154\147"], "\x6c\141\x62\145\x6c" => "\101\144\x64\x20\x52\x75\154\145"]); goto A13a7; e7771: } private function handleFirewallRuleForm(Request $request, Form $form, FirewallRuleManager $firewallRuleManager) { goto Fb3dd; da068: f754e: goto Eab9f; d334b: goto c5ca9; goto da068; Eab9f: try { goto b5e31; Cc802: $firewallRuleManager->updateEntity($proftpdPassivePortsFirewallRule); goto c181a; dce68: $proftpdPassivePortsFirewallRule = $firewallRuleManager->createEntity(); goto acad4; aca8f: $this->setUfwFirewallRules($firewallRuleManager); goto abdb9; abdb9: EventQueue::addEvent(EventQueue::EVENT_FIREWALL_RULE_CREATE, $user, $eventData, $request); goto B193e; B193e: $session->getFlashBag()->set("\163\x75\143\x63\145\x73\x73", $this->translator->trans("\x52\x75\154\145\40\x68\x61\x73\x20\142\x65\145\x6e\40\141\x64\144\145\x64\x2e")); goto c2407; E9c37: $proftpdPassivePortsFirewallRule->setSource($firewallRule->getSource()); goto B1f5b; d02df: $ufwFirewall->allow($firewallRule->getSource(), $ufwFirewallPortRange, true); goto A011c; acad4: $proftpdPassivePortsFirewallRule->setPortRange(sprintf("\45\163\55\45\163", FirewallRule::PROFTPD_PASSIVE_PORTS_FROM, FirewallRule::PROFTPD_PASSIVE_PORTS_TO)); goto E9c37; c18a4: $firewallRule = $form->getData(); goto c3b4d; c181a: c8f6c: goto Dd929; a2d90: $session = $request->getSession(); goto c18a4; c3b4d: $ufwFirewallPortRange = implode("\x3a", explode("\x2d", $firewallRule->getPortRange())); goto be249; ce74b: if (!(FirewallRule::FTP_DATA_PORT == substr($firewallRule->getPortRange(), 0, 2))) { goto c8f6c; } goto dce68; B1f5b: $proftpdPassivePortsFirewallRule->setDescription($firewallRule->getDescription()); goto Cc802; Dd929: $eventData = ["\x70\157\162\164\x52\x61\156\147\x65" => $firewallRule->getPortRange(), "\163\157\x75\x72\x63\x65" => $firewallRule->getSource(), "\x64\x65\x73\x63\x72\151\160\x74\x69\157\156" => $firewallRule->getDescription()]; goto aca8f; c2407: $response = $this->redirect($this->generateUrl("\143\154\x70\137\141\x64\x6d\x69\x6e\x5f\146\151\162\x65\x77\x61\154\154")); goto fd460; be249: $ufwFirewall = new UfwFirewall(); goto d02df; A011c: $firewallRuleManager->updateEntity($firewallRule); goto ce74b; fd460: return $response; goto edbb2; b5e31: $user = $this->getUser(); goto a2d90; edbb2: } catch (\Exception $e) { $this->logger->exception($e); $session->getFlashBag()->set("\x64\141\x6e\147\145\162", $this->translator->trans("\101\x6e\x20\x65\162\x72\157\162\40\150\x61\163\x20\x6f\x63\x63\x75\x72\x72\145\144\54\40\x65\162\x72\157\162\x20\x6d\145\x73\x73\141\147\x65\x3a\40\x25\145\x72\162\157\x72\x4d\x65\163\163\x61\x67\145\45", ["\45\x65\x72\162\x6f\x72\115\x65\163\x73\141\147\145\x25" => $e->getMessage()])); } goto adf4f; Fb3dd: if (true === $form->isValid()) { goto f754e; } goto cefa6; adf4f: c5ca9: goto D7e32; cefa6: $this->formErrors = $this->getErrorMessages($form); goto d334b; D7e32: } public function editRule(Request $request, FirewallRuleManager $firewallRuleManager) : Response { goto F6a64; F50cd: fdb4e: goto C07d1; F6a64: $id = (int) $request->get("\x69\x64"); goto Ba750; Ba750: $firewallRule = $firewallRuleManager->findOneById($id); goto D88b2; Bd32c: return $response; goto f4f7f; a5eb9: $form = $this->createFirewallRuleEditForm($firewallRule); goto fa4b4; fa4b4: if (!(true === $request->isMethod("\x50\x4f\x53\124"))) { goto fdb4e; } goto A7308; D88b2: if (!(true == is_null($firewallRule))) { goto Fd471; } goto b063a; Da633: return $response; goto d60b5; d60b5: edae3: goto C84f2; A7308: $form->handleRequest($request); goto B8a94; b063a: $response = $this->redirect($this->generateUrl("\143\154\x70\137\141\144\155\151\156\x5f\146\x69\x72\145\167\141\154\154")); goto F01b9; C84f2: Ef7e0: goto F50cd; C07d1: $response = $this->render("\101\x64\155\151\156\x2f\123\x65\143\165\x72\x69\164\x79\x2f\106\151\x72\145\167\x61\x6c\x6c\57\x65\144\x69\x74\55\x72\x75\x6c\145\x2e\x68\x74\155\154\56\164\x77\151\147", ["\146\x6f\162\x6d" => $form->createView(), "\146\157\162\155\105\x72\162\x6f\162\x73" => $this->formErrors]); goto Bd32c; f6121: Fd471: goto a5eb9; Ef688: if (!(false === is_null($response))) { goto edae3; } goto Da633; c2d76: $response = $this->handleFirewallRuleEditForm($request, $form, $firewallRuleManager); goto Ef688; B8a94: if (!(true === $form->isSubmitted())) { goto Ef7e0; } goto c2d76; F01b9: return $response; goto f6121; f4f7f: } private function createFirewallRuleEditForm(FirewallRule $firewallRule) : Form { goto cf4f5; d9b5a: $form->add("\x73\165\x62\x6d\151\164", SubmitType::class, ["\x61\164\164\162" => ["\143\154\x61\x73\163" => "\142\164\x6e\40\x62\164\156\55\142\154\x75\x65\x20\142\x74\x6e\55\154\147"], "\x6c\x61\142\145\154" => "\x53\x61\166\145"]); goto B4ef7; B4ef7: return $form; goto ee755; cf4f5: $form = $this->createForm("\101\x70\160\x5c\106\157\162\155\134\101\x64\155\151\156\x46\151\x72\x65\167\x61\154\x6c\x52\165\x6c\145\x45\x64\151\x74\x54\x79\x70\145", $firewallRule, ["\141\143\x74\151\x6f\x6e" => $this->generateUrl("\143\x6c\x70\x5f\x61\x64\155\151\156\x5f\146\151\162\145\167\141\154\154\x5f\x72\165\154\145\x5f\x65\x64\151\x74", ["\151\144" => $firewallRule->getId()]), "\x6d\145\x74\x68\x6f\x64" => "\x50\x4f\x53\124", "\x61\164\164\x72" => []]); goto d9b5a; ee755: } private function handleFirewallRuleEditForm(Request $request, Form $form, FirewallRuleManager $firewallRuleManager) { goto E7aaf; c79c1: $this->formErrors = $this->getErrorMessages($form); goto F5482; E7aaf: if (true === $form->isValid()) { goto e3803; } goto c79c1; F7e60: e3803: goto Feb4c; Feb4c: try { goto D8484; fc3ad: return $response; goto Cf0ec; aa513: $response = $this->redirect($this->generateUrl("\143\x6c\x70\x5f\141\x64\155\x69\x6e\x5f\146\x69\x72\x65\167\141\x6c\x6c")); goto fc3ad; d9a20: $ufwFirewall->allow($firewallRule->getSource(), $ufwFirewallPortRange, true); goto f1716; f1716: $firewallRuleManager->updateEntity($firewallRule); goto Cf1b4; B4219: $session->getFlashBag()->set("\x73\165\143\x63\x65\x73\x73", $this->translator->trans("\122\165\154\x65\40\150\x61\x73\40\142\145\x65\x6e\40\165\160\x64\141\x74\145\144\56")); goto aa513; Afaee: $session = $request->getSession(); goto a4ec5; F75f1: $ufwFirewall = new UfwFirewall(); goto d9a20; Cf1b4: $eventData = ["\x70\157\162\164\x52\141\x6e\x67\x65" => $firewallRule->getPortRange(), "\x73\x6f\x75\162\143\x65" => $firewallRule->getSource(), "\144\145\163\143\162\151\160\164\x69\x6f\x6e" => $firewallRule->getDescription()]; goto b8034; a4ec5: $firewallRule = $form->getData(); goto C22eb; D8484: $user = $this->getUser(); goto Afaee; b8034: $this->setUfwFirewallRules($firewallRuleManager); goto b95c8; C22eb: $ufwFirewallPortRange = implode("\72", explode("\55", $firewallRule->getPortRange())); goto F75f1; b95c8: EventQueue::addEvent(EventQueue::EVENT_FIREWALL_RULE_UPDATE, $user, $eventData, $request); goto B4219; Cf0ec: } catch (\Exception $e) { $this->logger->exception($e); $session->getFlashBag()->set("\x64\141\156\x67\x65\162", $this->translator->trans("\101\x6e\40\x65\162\x72\157\162\x20\150\141\x73\x20\157\x63\x63\x75\x72\x72\x65\144\x2c\40\x65\x72\162\157\162\40\155\x65\163\x73\141\147\x65\x3a\40\x25\x65\x72\162\157\x72\x4d\x65\x73\x73\x61\x67\x65\45", ["\x25\145\x72\x72\x6f\162\x4d\145\163\x73\x61\147\x65\45" => $e->getMessage()])); } goto ae3ae; ae3ae: db05c: goto b83bb; F5482: goto db05c; goto F7e60; b83bb: } public function deleteRule(Request $request, FirewallRuleManager $firewallRuleManager) : Response { goto b94fe; ba323: $session = $request->getSession(); goto da60d; C0aad: $firewallRule = $firewallRuleManager->findOneById($id); goto a00c5; a88a6: $response = $this->redirect($this->generateUrl("\143\154\x70\x5f\141\144\155\x69\156\x5f\146\151\x72\145\167\141\154\154")); goto caaac; af536: $eventData = ["\160\x6f\x72\164\x52\x61\x6e\147\x65" => $firewallRule->getPortRange(), "\163\157\165\x72\143\x65" => $firewallRule->getSource(), "\144\x65\x73\x63\162\x69\x70\x74\x69\x6f\x6e" => $firewallRule->getDescription()]; goto D6c82; F7f5c: $session->getFlashBag()->set("\163\165\x63\x63\x65\163\163", $this->translator->trans("\122\165\x6c\x65\40\150\141\163\40\142\x65\145\x6e\x20\x64\145\154\145\x74\x65\144\x2e")); goto Afbe1; Afbe1: A4710: goto a88a6; a00c5: if (!(false === is_null($firewallRule))) { goto A4710; } goto Be5fd; da60d: $firewallRuleManager->deleteEntity($firewallRule); goto af536; caaac: return $response; goto Da777; b94fe: $id = (int) $request->get("\x69\x64"); goto C0aad; Be5fd: $user = $this->getUser(); goto ba323; D6c82: $this->setUfwFirewallRules($firewallRuleManager); goto ac122; ac122: EventQueue::addEvent(EventQueue::EVENT_FIREWALL_RULE_DELETE, $user, $eventData, $request); goto F7f5c; Da777: } private function setUfwFirewallRules(FirewallRuleManager $firewallRuleManager) : void { goto b0f21; E5ad9: $ufwFirewall = new UfwFirewall(); goto Bea90; Dfa85: $ufwFirewall->enable(); goto a623d; Ae265: c331f: goto Dfa85; abe34: if (count($firewallRules)) { goto b1dba; } goto Defd7; b0f21: $firewallRules = $firewallRuleManager->findAll(); goto E5ad9; Bea90: $ufwFirewall->reset(); goto abe34; e8dd8: goto de713; goto Cd286; Defd7: $ufwFirewall->disable(); goto e8dd8; Cd286: b1dba: goto f4be7; a623d: de713: goto a3d01; f4be7: foreach ($firewallRules as $firewallRule) { goto bc52e; D3dd8: $ufwFirewall->allow($firewallRule->getSource(), $portRange); goto F6860; F6860: A9ada: goto ba1df; bc52e: $portRange = implode("\x3a", explode("\55", $firewallRule->getPortRange())); goto D3dd8; ba1df: } goto Ae265; a3d01: } }
