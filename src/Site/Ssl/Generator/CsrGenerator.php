<?php
 namespace App\Site\Ssl\Generator; use App\Site\Ssl\DistinguishedName; use App\Site\Ssl\PrivateKey; class CsrGenerator { const DIGEST_ALGORITHM = "\x73\150\x61\62\x35\x36"; private $privateKey; private $distinguishedName; public static $sslConfigTemplate = "\133\x20\x72\x65\161\x20\x5d\12\144\x69\163\x74\151\x6e\147\165\x69\x73\x68\x65\144\137\x6e\141\x6d\145\40\x3d\x20\x72\145\161\x5f\x64\x69\163\x74\151\x6e\147\x75\151\163\x68\x65\144\x5f\156\x61\x6d\145\xa\162\145\161\137\x65\170\164\145\156\x73\151\157\156\163\x20\x3d\40\x76\63\137\162\x65\x71\xa\x5b\40\162\145\161\137\144\151\163\164\x69\x6e\147\165\x69\163\150\145\x64\x5f\x6e\x61\155\145\x20\135\xa\133\x20\x76\63\137\162\145\x71\x20\x5d\xa\x62\141\x73\151\x63\x43\x6f\x6e\163\x74\x72\141\x69\156\164\163\40\75\40\x43\x41\x3a\x46\x41\x4c\x53\x45\12\153\145\x79\x55\x73\141\x67\145\x20\x3d\x20\x6e\x6f\156\x52\145\x70\165\144\x69\141\164\151\x6f\x6e\54\x20\x64\x69\147\x69\x74\x61\x6c\x53\151\147\156\x61\164\x75\x72\x65\54\40\x6b\145\171\105\156\143\x69\x70\150\x65\162\155\x65\156\x74\xa\x65\170\x74\145\x6e\x64\x65\x64\113\x65\x79\x55\163\x61\x67\145\x20\x3d\40\x73\145\162\166\145\162\101\x75\164\x68\x2c\40\x63\x6c\x69\145\156\x74\101\165\x74\150\54\x20\143\x6f\x64\x65\x53\151\147\x6e\151\x6e\147\x2c\x20\145\x6d\x61\151\154\120\162\x6f\x74\145\x63\164\x69\x6f\156\12\163\165\142\x6a\x65\143\164\x41\154\164\116\x61\155\x65\x20\75\40\x24\173\x45\116\x56\72\72\120\x48\x50\137\x50\x41\x53\x53\137\123\x55\x42\112\105\x43\124\101\114\124\116\x41\115\x45\x7d\12\133\40\165\163\x72\x5f\x63\x65\x72\x74\40\x5d\xa\x62\141\163\151\x63\x43\157\x6e\163\x74\162\141\151\156\164\x73\x3d\x43\x41\x3a\106\101\x4c\123\x45\xa\x6e\x73\103\157\155\x6d\145\x6e\x74\40\x3d\x20\x22\117\160\x65\156\x53\x53\114\40\x47\x65\156\x65\162\x61\164\145\x64\40\103\x65\x72\164\x69\x66\x69\143\141\x74\x65\x22\xa\153\145\171\125\163\x61\147\x65\40\x3d\40\x6e\157\156\122\145\x70\x75\x64\x69\141\x74\x69\x6f\156\54\x20\144\x69\x67\151\x74\x61\154\123\x69\x67\156\x61\x74\x75\162\x65\54\x20\x6b\x65\x79\105\x6e\143\x69\x70\150\x65\162\155\x65\x6e\x74\xa\145\170\x74\145\156\144\145\144\x4b\145\x79\x55\x73\x61\x67\x65\x20\x3d\40\x73\x65\x72\166\x65\162\101\165\x74\150\x2c\x20\143\154\151\x65\156\164\101\x75\164\x68\54\x20\143\x6f\144\145\x53\x69\x67\156\x69\x6e\147\x2c\x20\x65\155\x61\x69\x6c\x50\162\x6f\164\145\x63\x74\x69\157\x6e\12\163\x75\x62\x6a\x65\x63\x74\x4b\145\171\111\x64\x65\x6e\x74\151\x66\151\x65\x72\x3d\150\x61\163\x68\xa\141\x75\x74\x68\x6f\162\151\164\x79\x4b\145\171\111\x64\x65\156\x74\151\x66\x69\145\x72\x3d\153\145\x79\151\144\54\x69\x73\x73\165\145\162\12\x73\165\x62\152\x65\x63\164\x41\154\x74\x4e\x61\x6d\145\x20\x3d\40\44\173\105\116\126\72\72\120\x48\120\x5f\x50\101\x53\123\137\x53\x55\102\x4a\105\103\x54\101\114\124\116\x41\115\105\137\x46\122\117\x4d\137\x43\123\122\x7d"; public function __construct(PrivateKey $privateKey, DistinguishedName $distinguishedName) { $this->privateKey = $privateKey; $this->distinguishedName = $distinguishedName; } public function generate() { goto A945e; A945e: $domains = array_merge([$this->distinguishedName->getCommonName()], $this->distinguishedName->getSubjectAlternativeNames()); goto Cc59b; Cc59b: $sslConfigFile = tempnam(sys_get_temp_dir(), "\143\x6c\x70\55\x6c\x65\55"); goto e3f88; e3f88: try { goto C8409; a2b6a: if (openssl_csr_export($csr, $csrExport)) { goto a6a43; } goto F97ae; Ea8f0: $csrData = $this->getCSRData(); goto eaa62; ea34d: return $csrExport; goto ac696; a6468: $csr = openssl_csr_new($csrData, $resource, ["\144\x69\x67\145\163\164\x5f\141\154\147" => self::DIGEST_ALGORITHM, "\x63\157\x6e\x66\151\147" => $sslConfigFile]); goto D4907; D4907: if (!(false === isset($csr))) { goto F0b05; } goto b14af; c3662: $resource = $this->privateKey->getResource(); goto Ea8f0; Ffd5b: putenv("\x50\x48\x50\137\x50\101\123\x53\137\123\125\x42\112\x45\103\x54\101\114\124\x4e\x41\x4d\x45\x3d" . implode("\x2c", $sanDomainPrefixed)); goto a6468; C8409: file_put_contents($sslConfigFile, self::$sslConfigTemplate); goto c3662; c09f3: F0b05: goto a2b6a; eaa62: $sanDomainPrefixed = array_map(function ($value) { return sprintf("\104\x4e\123\72\x20\x25\163", $value); }, $domains); goto F6583; b14af: throw new Exception(sprintf("\117\x70\x65\x6e\x53\123\114\40\103\x53\x52\x20\x73\151\x67\x6e\x69\156\147\x20\146\x61\151\154\x65\144\40\167\x69\x74\150\x20\x65\x72\x72\x6f\162\x3a\40\x25\x73", openssl_error_string())); goto c09f3; F6583: putenv("\120\x48\x50\x5f\x50\101\x53\x53\x5f\x53\125\102\x4a\105\x43\124\101\x4c\x54\116\x41\115\x45\137\106\122\117\115\x5f\103\123\x52\x3d" . implode("\x2c", $sanDomainPrefixed)); goto Ffd5b; b07c8: a6a43: goto ea34d; F97ae: throw new \Exception(sprintf("\117\x70\x65\156\123\x53\114\x20\103\x53\x52\x20\163\151\x67\156\151\156\147\40\146\141\151\x6c\x65\144\40\x77\x69\x74\150\x20\x65\x72\162\157\162\72\40\x25\x73", openssl_error_string())); goto b07c8; ac696: } finally { unlink($sslConfigFile); } goto Fa04c; Fa04c: } private function getCSRData() { goto C9640; F944f: $data["\145\x6d\x61\x69\x6c\101\144\x64\162\145\163\163"] = $this->distinguishedName->getEmailAddress(); goto aaa8c; Accf1: if (!(false === is_null($this->distinguishedName->getStateOrProvinceName()))) { goto f571b; } goto c5334; Eb2e9: e49cc: goto ae5dd; Cd233: if (!(false === is_null($this->distinguishedName->getLocalityName()))) { goto e49cc; } goto d06e5; b8934: return $data; goto ac7a0; B3caa: f571b: goto Cd233; ae5dd: if (!(false === is_null($this->distinguishedName->getOrganizationName()))) { goto fca2d; } goto caa35; ee09a: if (!(false === is_null($this->distinguishedName->getCountryName()))) { goto B09e6; } goto E3212; ed1d1: if (!(false === is_null($this->distinguishedName->getEmailAddress()))) { goto Ac316; } goto F944f; De470: if (!(false === is_null($this->distinguishedName->getCommonName()))) { goto Efcf4; } goto cee60; E3212: $data["\x63\157\x75\x6e\x74\162\171\116\141\155\145"] = $this->distinguishedName->getCountryName(); goto Cfb7d; b011b: Efcf4: goto ed1d1; cee60: $data["\143\157\155\x6d\157\156\x4e\x61\155\x65"] = $this->distinguishedName->getCommonName(); goto b011b; c5334: $data["\163\x74\x61\164\x65\x4f\x72\x50\x72\x6f\x76\151\x6e\x63\x65\116\x61\155\x65"] = $this->distinguishedName->getStateOrProvinceName(); goto B3caa; d06e5: $data["\154\157\143\x61\154\151\x74\x79\116\x61\x6d\145"] = $this->distinguishedName->getLocalityName(); goto Eb2e9; F9d25: $data["\x6f\x72\147\141\156\151\172\x61\164\x69\157\x6e\x61\154\125\156\151\164\x4e\x61\x6d\x65"] = $this->distinguishedName->getOrganizationalUnitName(); goto B9905; D623c: if (!(false === is_null($this->distinguishedName->getOrganizationalUnitName()))) { goto fd33c; } goto F9d25; caa35: $data["\157\162\x67\x61\156\151\172\141\x74\x69\157\x6e\116\141\x6d\x65"] = $this->distinguishedName->getOrganizationName(); goto a3bcc; B9905: fd33c: goto De470; C9640: $data = []; goto ee09a; aaa8c: Ac316: goto b8934; a3bcc: fca2d: goto D623c; Cfb7d: B09e6: goto Accf1; ac7a0: } }
