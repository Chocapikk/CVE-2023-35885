<?php
 namespace App\Security\Admin; use App\System\Command\ServiceReloadCommand; use App\System\CommandExecutor; use App\System\Command\WriteFileCommand; use App\System\Command\DeleteFileCommand; use App\System\Command\ChownCommand; use App\System\Command\ChmodCommand; use App\System\Command\FindChmodCommand; use App\Site\Ssl\LetsEncrypt\CertificateOrder; use App\Site\Ssl\Certificate; class CustomDomain { public const WELL_KNOWN_DIRECTORY = "\x2f\x68\x6f\155\x65\x2f\143\x6c\160\57\150\164\144\x6f\143\x73\57\x61\160\x70\x2f\146\151\154\x65\x73\57\160\x75\x62\x6c\151\143\57\56\167\x65\x6c\154\55\153\x6e\157\167\x6e\57"; public const ACME_CHALLENGE_DIRECTORY = "\x2f\150\x6f\155\x65\x2f\143\x6c\x70\x2f\x68\164\144\x6f\143\163\57\141\160\160\57\x66\151\154\x65\x73\57\160\x75\x62\x6c\x69\x63\57\56\167\x65\154\x6c\x2d\x6b\x6e\x6f\x77\156\x2f\141\x63\155\x65\55\x63\150\x61\x6c\154\145\x6e\147\145\x2f"; public const PRIVATE_KEY_FILE = "\x2f\x65\x74\143\57\156\x67\151\156\170\57\x73\x73\x6c\x2d\143\145\162\x74\x69\146\x69\x63\x61\164\x65\163\57\x63\x75\163\x74\x6f\x6d\x2d\x64\x6f\155\141\151\156\56\153\x65\x79"; public const CERTIFICATE_FILE = "\x2f\145\x74\x63\x2f\x6e\x67\x69\156\170\57\x73\x73\x6c\x2d\x63\x65\162\x74\151\146\x69\x63\141\x74\145\163\57\143\x75\163\x74\157\155\55\x64\x6f\x6d\141\151\x6e\56\x63\162\x74"; public const VHOST_FILE = "\x2f\x65\164\x63\57\x6e\147\151\x6e\x78\x2f\x73\151\x74\145\163\55\145\x6e\141\x62\x6c\x65\x64\57\143\x75\x73\164\x6f\155\x2d\x64\157\x6d\141\151\156\56\x63\x6f\156\146"; public const CUSTOM_DOMAIN_MOTD_FILE = "\57\145\x74\143\57\x2e\x63\x6c\160\x5f\143\165\x73\164\x6f\x6d\x5f\x64\x6f\155\x61\x69\156"; private CommandExecutor $commandExecutor; public function __construct() { $this->commandExecutor = new CommandExecutor(); } public function deleteLetsEncryptChallengeFiles() { goto B134d; e3d90: $this->commandExecutor->execute($deleteLetsEncryptChallengeFilesCommand); goto Cab25; B134d: $deleteLetsEncryptChallengeFiles = sprintf("\45\x73\57\52", rtrim(self::ACME_CHALLENGE_DIRECTORY, "\x2f")); goto Eecec; C80e8: $deleteLetsEncryptChallengeFilesCommand->setFile($deleteLetsEncryptChallengeFiles); goto e3d90; Eecec: $deleteLetsEncryptChallengeFilesCommand = new DeleteFileCommand(); goto C80e8; Cab25: } public function createLetsEncryptChallengeFiles(CertificateOrder $certificateOrder) : void { goto d7af4; A909c: $chmodWellKnownDirectoryCommand->setFile(self::WELL_KNOWN_DIRECTORY); goto Db152; B5ef2: $this->commandExecutor->execute($chownWellKnownDirectoryCommandCommand); goto a2dc1; F5865: foreach ($challenges as $challenge) { goto Ce4ec; bcc37: $challengeFile = sprintf("\45\163\57\x25\x73", rtrim(self::ACME_CHALLENGE_DIRECTORY, "\57"), $token); goto De05b; Ce4ec: $token = $challenge["\x74\x6f\153\x65\156"] ?? null; goto ecac5; Ee3af: $challengeWriteFileCommand->setFile($challengeFile); goto D9d45; ecac5: $verificationContent = $challenge["\166\145\x72\x69\x66\151\x63\141\x74\x69\157\156\x43\157\x6e\164\145\x6e\164"] ?? null; goto D67b1; D9d45: $challengeWriteFileCommand->setContent($verificationContent); goto f0c62; c55fc: df0d2: goto D0ae2; D67b1: if (!(false === is_null($token) && false === is_null($verificationContent))) { goto b52e4; } goto bcc37; f0c62: $this->commandExecutor->execute($challengeWriteFileCommand); goto eff62; De05b: $challengeWriteFileCommand = new WriteFileCommand(); goto Ee3af; eff62: b52e4: goto c55fc; D0ae2: } goto bd135; ec1c3: $chmodWellKnownDirectoryCommand = new FindChmodCommand(); goto A909c; f79c8: $chownWellKnownDirectoryCommandCommand->setRecursive(true); goto cc8b5; Db152: $chmodWellKnownDirectoryCommand->setDirectoryChmod(750); goto B9bc3; Ed57f: $chownWellKnownDirectoryCommandCommand->setGroup("\x63\154\160"); goto ec1c3; B9bc3: $chmodWellKnownDirectoryCommand->setFileChmod(770); goto B5ef2; bd135: Cdd41: goto b8842; A1b90: $chownWellKnownDirectoryCommandCommand->setFile(self::WELL_KNOWN_DIRECTORY); goto f79c8; e9052: if (!count($challenges)) { goto e9fae; } goto F5865; b8842: e9fae: goto Cac70; a2dc1: $this->commandExecutor->execute($chmodWellKnownDirectoryCommand); goto b8011; Cac70: $chownWellKnownDirectoryCommandCommand = new ChownCommand(); goto A1b90; cc8b5: $chownWellKnownDirectoryCommandCommand->setUser("\x63\154\x70"); goto Ed57f; d7af4: $challenges = $certificateOrder->getAuthorizationsChallenges(); goto e9052; b8011: } public function writePrivateKeyAndCertificate(Certificate $certificate) : void { goto c6306; a54d5: $writePrivateKeyFileCommand = new WriteFileCommand(); goto B9af5; C4d1f: $this->commandExecutor->execute($writeCertificateFileCommand); goto c0cf1; C8f75: if (!(false === empty($certificate->getCertificateChain()))) { goto cb452; } goto B762f; B75d9: $writeCertificateFileCommand->setContent($certificateContent); goto E8726; A2c33: cb452: goto a54d5; B9af5: $writePrivateKeyFileCommand->setFile(self::PRIVATE_KEY_FILE); goto B8e13; E8726: $this->commandExecutor->execute($writePrivateKeyFileCommand); goto C4d1f; b296e: $writeCertificateFileCommand = new WriteFileCommand(); goto A0293; B8e13: $writePrivateKeyFileCommand->setContent($certificate->getPrivateKey()); goto b296e; B762f: $certificateContent .= sprintf("\45\163\x25\x73", PHP_EOL, trim($certificate->getCertificateChain())); goto A2c33; c6306: $certificateContent = $certificate->getCertificate(); goto C8f75; A0293: $writeCertificateFileCommand->setFile(self::CERTIFICATE_FILE); goto B75d9; c0cf1: } public function writeVhostFile(string $domainName, string $vhostTemplate) : void { goto D8ee1; F6f0e: $writeVhostFileCommand = new WriteFileCommand(); goto E83b3; aabe6: $writeVhostFileCommand->setContent($vhostTemplate); goto D4948; D8ee1: $vhostTemplate = str_replace("\x7b\x7b\163\x65\x72\166\x65\x72\x5f\156\x61\x6d\x65\x7d\x7d", $domainName, $vhostTemplate); goto F6f0e; E83b3: $writeVhostFileCommand->setFile(self::VHOST_FILE); goto aabe6; D4948: $this->commandExecutor->execute($writeVhostFileCommand); goto be6a5; be6a5: } public function writeMotdFile(string $domainName) : void { goto fe02d; ac319: $chownMotdFileCommand->setUser("\x63\x6c\160"); goto a9621; F8f89: $chmodMotdFileCommand->setChmod(744); goto f468b; Baaad: $writeMotdFileCommand->setFile(self::CUSTOM_DOMAIN_MOTD_FILE); goto c0bec; D8838: $chownMotdFileCommand->setFile(self::CUSTOM_DOMAIN_MOTD_FILE); goto ac319; E7070: $this->commandExecutor->execute($chownMotdFileCommand); goto F4b89; F4b89: $this->commandExecutor->execute($chmodMotdFileCommand); goto B6b84; f468b: $this->commandExecutor->execute($writeMotdFileCommand); goto E7070; a9621: $chownMotdFileCommand->setGroup("\143\154\x70"); goto e6532; e6532: $chmodMotdFileCommand = new ChmodCommand(); goto ff696; A67f7: $chownMotdFileCommand = new ChownCommand(); goto D8838; fe02d: $writeMotdFileCommand = new WriteFileCommand(); goto Baaad; ff696: $chmodMotdFileCommand->setFile(self::CUSTOM_DOMAIN_MOTD_FILE); goto F8f89; c0bec: $writeMotdFileCommand->setContent($domainName); goto A67f7; B6b84: } public function reloadNginx() : void { $this->reloadService("\156\x67\x69\x6e\x78"); } public function delete() : void { goto B301a; e73c0: $deleteCertificateFileCommand->setFile(self::CERTIFICATE_FILE); goto b0fea; Bf491: $deleteVhostFileCommand->setFile(self::VHOST_FILE); goto A2d14; Beb5f: $deletePrivateKeyFileCommand->setFile(self::PRIVATE_KEY_FILE); goto C9e76; b0fea: $deleteVhostFileCommand = new DeleteFileCommand(); goto Bf491; B9055: $this->commandExecutor->execute($deleteVhostFileCommand); goto Bf090; C9e76: $deleteCertificateFileCommand = new DeleteFileCommand(); goto e73c0; A2d14: $deleteMotdFileCommand = new DeleteFileCommand(); goto d11d6; d11d6: $deleteMotdFileCommand->setFile(self::CUSTOM_DOMAIN_MOTD_FILE); goto D3c11; D3c11: $this->commandExecutor->execute($deletePrivateKeyFileCommand); goto Ec51c; B301a: $deletePrivateKeyFileCommand = new DeleteFileCommand(); goto Beb5f; Bf090: $this->commandExecutor->execute($deleteMotdFileCommand); goto f6e49; Ec51c: $this->commandExecutor->execute($deleteCertificateFileCommand); goto B9055; f6e49: $this->reloadService("\156\x67\151\156\170"); goto e3cdf; e3cdf: } public function reloadService($serviceName) { goto E41cf; E41cf: if (!("\x64\x65\166" != $_ENV["\x41\x50\120\137\x45\116\x56"])) { goto C5da6; } goto Ee501; bf217: C5da6: goto d1fbc; eefce: $this->commandExecutor->execute($reloadServiceCommand); goto bf217; fed81: $reloadServiceCommand->setServiceName($serviceName); goto eefce; Ee501: $reloadServiceCommand = new ServiceReloadCommand(); goto fed81; d1fbc: } }
