<?php
 namespace App\Command; use Symfony\Component\Console\Input\InputInterface; use Symfony\Component\Console\Input\InputOption; use Symfony\Component\Console\Output\OutputInterface; use Symfony\Component\Filesystem\Filesystem; use Symfony\Component\Finder\Finder; use Symfony\Component\Process\Exception\ProcessFailedException; use Symfony\Component\Process\Process; use App\Command\Command as BaseCommand; use App\Entity\Manager\VhostTemplateManager as VhostTemplateEntityManager; use App\Entity\VhostTemplate as VhostTemplateEntity; class VhostTemplatesImportCommand extends BaseCommand { private const GIT_REPOSITORY = "\150\x74\164\160\163\x3a\57\57\147\x69\x74\150\165\x62\x2e\143\x6f\x6d\57\143\154\157\x75\x64\x70\141\x6e\x65\x6c\55\151\x6f\57\166\x68\x6f\x73\164\x2d\164\x65\155\x70\x6c\x61\x74\145\x73\56\x67\x69\164"; private const TEMPLATES_VERSION = "\x32\55\166\x61\x72\x6e\151\163\x68"; private const GIT_CLONE_PROCESS_TIMEOUT = 600; private VhostTemplateEntityManager $vhostTemplateEntityManager; private int $numberOfImportedVhostTemplates = 0; public function __construct(VhostTemplateEntityManager $vhostTemplateEntityManager) { $this->vhostTemplateEntityManager = $vhostTemplateEntityManager; parent::__construct(); } protected function configure() : void { goto A97fa; A97fa: $this->setName("\166\150\x6f\163\x74\55\164\x65\x6d\x70\154\x61\164\145\163\72\x69\x6d\x70\157\x72\x74"); goto ed227; A73eb: $this->addOption("\144\x65\154\141\x79", null, InputOption::VALUE_OPTIONAL, false); goto d6220; ed227: $this->setDescription("\x63\x6c\160\143\x74\x6c\40\x76\150\157\163\164\x2d\x74\x65\x6d\160\154\141\x74\x65\163\72\151\x6d\x70\x6f\162\x74"); goto A73eb; d6220: } protected function execute(InputInterface $input, OutputInterface $output) : int { try { goto e212e; e53d7: if (!(true === $delay)) { goto A9001; } goto a7f0f; def14: A9001: goto c0378; B7fab: $output->writeln(sprintf("\x3c\x69\156\146\157\76\x25\163\40\x56\x68\x6f\x73\x74\40\124\145\155\160\154\x61\x74\x65\x73\40\150\141\x76\x65\40\142\145\x65\156\x20\151\x6d\x70\157\162\x74\x65\144\56\x3c\57\151\x6e\x66\x6f\76", $this->numberOfImportedVhostTemplates)); goto F23b6; c0378: $this->importVhostTemplates(); goto B7fab; F23b6: return SiteCommand::SUCCESS; goto C2847; e212e: $delay = (bool) $input->getOption("\144\145\154\x61\x79"); goto e53d7; a7f0f: sleep(rand(1, 180)); goto def14; C2847: } catch (\Exception $e) { goto F4727; a0121: $output->writeln(sprintf("\x3c\x65\162\162\157\x72\x3e\45\163\x3c\x2f\145\x72\162\x6f\162\76", $errorMessage)); goto Cdb28; Cdb28: return SiteCommand::FAILURE; goto eb9d4; F4727: $errorMessage = $e->getMessage(); goto a0121; eb9d4: } } private function importVhostTemplates() { try { goto Cff89; f9d1f: $process->setTimeout(self::GIT_CLONE_PROCESS_TIMEOUT); goto Ebc06; C7c9c: e9b8a: goto b3958; E69b9: if (false === empty($applications)) { goto a0453; } goto E1dd1; E1dd1: throw new \Exception("\116\157\40\166\x68\x6f\163\x74\40\164\145\155\x70\154\141\x74\145\x73\x20\146\x6f\x75\156\x64\56"); goto Cba05; b3958: Eab91: goto eedaa; C6f45: throw new \Exception(sprintf("\x44\151\162\x65\143\x74\x6f\x72\x79\40\42\45\163\x22\x20\144\157\145\163\x20\156\157\x74\40\x65\x78\x69\163\x74\x2e", $vhostTemplatesDirectory)); goto ff014; A398e: $applicationIterator = new \DirectoryIterator($vhostTemplatesDirectory); goto E89db; F73e7: $applications = []; goto C8a92; ea287: cf89d: goto C86cc; df036: if (true === is_dir($vhostTemplatesDirectory)) { goto e25dd; } goto C6f45; Cff89: $filesystem = new Filesystem(); goto Fe121; fe44a: fbf98: goto F73e7; F8697: $this->vhostTemplateEntityManager->deleteTemplatesByType(VhostTemplateEntity::TYPE_SYSTEM); goto C5c4d; be1da: goto cf89d; goto fe44a; d76ff: a0453: goto F8697; ff014: goto Beb84; goto c477b; Fe121: $tmpVhostTemplatesDirectory = sprintf("\45\163\x2f\45\x73\57", rtrim(sys_get_temp_dir(), "\57"), uniqid()); goto C92e6; C8a92: $vhostTemplatesDirectory = sprintf("\45\163\57\x76\x25\163\x2f", rtrim($tmpVhostTemplatesDirectory, "\x2f"), self::TEMPLATES_VERSION); goto df036; C92e6: $gitCloneCommand = sprintf("\57\165\163\x72\x2f\x62\151\x6e\57\x67\151\164\40\x63\x6c\157\x6e\x65\x20\45\163\40\x25\163", self::GIT_REPOSITORY, $tmpVhostTemplatesDirectory); goto Bdbc3; b7981: f1cf3: goto E69b9; c477b: e25dd: goto A398e; Bdbc3: $process = Process::fromShellCommandline($gitCloneCommand); goto f9d1f; E89db: foreach ($applicationIterator as $fileInfo) { goto f141d; ef1dc: $finder->files()->in($applicationVhostTemplateDirectory); goto F747d; F747d: if (!(true === $finder->hasResults())) { goto E1990; } goto F35c9; fae48: $finder = new Finder(); goto ef1dc; F35c9: foreach ($finder as $file) { goto d14ff; e1b3f: $fileObject->seek(0); goto B63a3; F0d3f: f02b1: goto d0172; Bf8fe: $data["\166\141\162\x6e\151\163\x68\103\x61\143\150\x65\x53\145\x74\164\x69\156\147\x73"] = $metaData["\x76\141\162\156\x69\163\x68\103\141\x63\150\145\123\145\x74\x74\151\x6e\x67\163"]; goto F0d3f; b73dc: $vhostTemplateName = $file->getFilename(); goto C1378; b6330: $metaData = @json_decode(trim(substr($metaData, 1)), true); goto A99c8; A722e: if (!(true === isset($metaData["\x70\x68\160\x56\x65\x72\x73\x69\157\x6e"]) && false === empty($metaData["\x70\x68\x70\126\145\x72\x73\x69\157\156"]))) { goto D1819; } goto F7dfe; b253a: F5dff: goto A722e; d67fb: $data["\162\157\157\164\x44\x69\x72\x65\143\x74\157\x72\x79"] = $metaData["\x72\x6f\x6f\164\x44\x69\162\145\143\x74\157\x72\171"]; goto b253a; edb92: $data = []; goto D89e7; A99c8: if (!(true === is_array($metaData))) { goto d89d4; } goto E5d90; b2153: $vhostTemplateContent = trim($fileObject->fread($file->getSize())); goto d4b0f; f15f6: $vhostTemplates[$vhostTemplateName] = $data; goto afb39; d0172: d89d4: goto b2153; d4b0f: C6816: goto b73dc; a399f: if (!("\x23" == substr($metaData, 0, 1))) { goto C6816; } goto b6330; F7dfe: $data["\x70\x68\x70\x56\x65\x72\163\x69\x6f\156"] = $metaData["\160\150\160\126\x65\x72\x73\151\x6f\156"]; goto bdd48; C1378: if (!(false === empty($vhostTemplateName) && false === empty($vhostTemplateContent))) { goto D0bd9; } goto C7df2; C7df2: $data["\164\x65\155\160\154\141\x74\145"] = $vhostTemplateContent; goto f15f6; bdd48: D1819: goto f2381; afb39: D0bd9: goto c6f6d; f2381: if (!(true === isset($metaData["\166\x61\x72\x6e\x69\163\x68\103\x61\x63\150\x65\123\145\164\x74\151\156\x67\163"]) && false === empty($metaData["\166\x61\162\x6e\x69\x73\150\103\141\143\x68\145\x53\145\164\164\x69\x6e\x67\x73"]))) { goto f02b1; } goto Bf8fe; c6f6d: Af3d9: goto be0d2; B63a3: $metaData = $fileObject->current(); goto edb92; d14ff: $fileObject = new \SplFileObject($file->getPathname()); goto e1b3f; E5d90: if (!(true === isset($metaData["\x72\157\157\x74\104\151\x72\145\143\164\x6f\162\x79"]) && false === empty($metaData["\x72\x6f\157\164\104\x69\162\x65\x63\x74\157\x72\171"]))) { goto F5dff; } goto d67fb; D89e7: $vhostTemplateContent = trim($file->getContents()); goto a399f; be0d2: } goto d6f80; Ba2bc: $applicationName = ucfirst($fileInfo->getFilename()); goto efbb1; f141d: if (!(true === $fileInfo->isDir() && "\56" != substr($fileInfo->getFilename(), 0, 1))) { goto Fd2e6; } goto Ba2bc; A36b8: E1990: goto cef8a; fd681: $vhostTemplates = []; goto fae48; c0a15: Eba6c: goto d8c9c; C07d2: ec20b: goto c0a15; efbb1: $applicationVhostTemplateDirectory = $fileInfo->getPathname(); goto E7496; d7723: e0dfe: goto Fdf92; d6f80: C6fbd: goto A36b8; B2263: $applications[$applicationName] = $vhostTemplates; goto C07d2; E7496: if (!(true === is_dir($applicationVhostTemplateDirectory))) { goto Eba6c; } goto fd681; cef8a: if (!(false === empty($vhostTemplates))) { goto ec20b; } goto B2263; d8c9c: Fd2e6: goto d7723; Fdf92: } goto b7981; eedaa: Beb84: goto ea287; Da6a2: throw new ProcessFailedException($process); goto be1da; Cba05: goto Eab91; goto d76ff; cb74f: if (true === $process->isSuccessful()) { goto fbf98; } goto Da6a2; C5c4d: foreach ($applications as $templates) { goto bbeb6; B03da: cc212: goto ac481; bbeb6: foreach ($templates as $name => $data) { goto D2c12; ed131: $vhostTemplateEntity->setVarnishCacheSettings($varnishCacheSettings); goto c42b2; cbff0: $vhostTemplateEntity->setPhpVersion($data["\x70\x68\160\x56\145\x72\163\x69\157\156"]); goto Ea6c6; fd3d2: d0d3e: goto F09c7; E4614: if (!(true === isset($data["\162\157\157\164\x44\x69\x72\x65\x63\x74\157\162\x79"]) && false === empty($data["\162\x6f\157\x74\104\x69\x72\145\143\x74\157\x72\x79"]))) { goto df2df; } goto eff03; F363d: $this->numberOfImportedVhostTemplates++; goto Dee38; Ac90b: $vhostTemplateEntity = $this->vhostTemplateEntityManager->createEntity(); goto c612c; Ea6c6: F08e4: goto cf7af; c5484: $vhostTemplateEntity->setType(VhostTemplateEntity::TYPE_SYSTEM); goto Ef123; D2c12: if (!(false === empty($name) && true === isset($data["\x74\x65\x6d\x70\x6c\141\x74\x65"]) && false === empty($data["\x74\145\x6d\160\154\x61\x74\145"]))) { goto Ef313; } goto Ac90b; Dee38: Ef313: goto fd3d2; c612c: $vhostTemplateEntity->setName($name); goto Df3c1; cd7d7: $vhostTemplateEntity->setRootDirectory($rootDirectory); goto F8068; eff03: $rootDirectory = ltrim(rtrim($data["\162\x6f\157\164\x44\151\162\x65\x63\164\x6f\x72\171"], "\57"), "\57"); goto cd7d7; Df3c1: $vhostTemplateEntity->setTemplate($data["\x74\x65\155\160\154\141\164\145"]); goto E4614; cf7af: if (!(true === isset($data["\x76\x61\162\x6e\x69\163\x68\x43\x61\x63\x68\145\123\145\x74\164\x69\x6e\147\x73"]) && false === empty($data["\166\x61\x72\156\x69\163\x68\103\141\143\150\145\123\x65\x74\164\151\x6e\x67\x73"]))) { goto b6406; } goto ca411; f53d0: if (!(true === isset($data["\160\x68\x70\126\x65\x72\x73\x69\x6f\x6e"]) && false === empty($data["\160\x68\160\x56\x65\x72\163\x69\157\156"]))) { goto F08e4; } goto cbff0; F8068: df2df: goto f53d0; Ef123: $this->vhostTemplateEntityManager->updateEntity($vhostTemplateEntity); goto F363d; c42b2: b6406: goto c5484; ca411: $varnishCacheSettings = json_encode($data["\x76\x61\x72\156\151\163\x68\103\x61\x63\x68\x65\123\145\164\164\151\156\x67\163"]); goto ed131; F09c7: } goto e9842; e9842: E34d3: goto B03da; ac481: } goto C7c9c; Ebc06: $process->run(); goto cb74f; C86cc: } catch (\Exception $e) { throw $e; } finally { if (!(true === isset($vhostTemplatesDirectory) && true === is_dir($vhostTemplatesDirectory))) { goto addd8; } $filesystem->remove($tmpVhostTemplatesDirectory); addd8: } } }
