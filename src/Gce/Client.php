<?php
 namespace App\Gce; use GuzzleHttp\Client as HttpClient; use GuzzleHttp\Psr7\Request; use GuzzleHttp\Psr7\Response; use Google\Service\Compute\Instance as GoogleServiceInstance; use Google\Service\Compute\Operation as GoogleServiceOperation; use App\CloudPanel\Gce\Instance as GceInstance; use App\Util\Retry; class Client { const META_DATA_HTTP_CLIENT_TIMEOUT = 30; const META_DATA_ENDPOINT = "\x68\x74\x74\x70\72\57\x2f\x6d\145\x74\x61\144\141\164\x61\57\x63\x6f\155\160\165\x74\145\115\x65\164\141\x64\x61\164\141\57\166\x31\57"; const GOOGLE_APIS_SCOPE_CLOUD_PLATFORM = "\150\164\x74\160\163\72\x2f\57\x77\167\x77\x2e\x67\x6f\157\147\x6c\145\141\x70\x69\x73\56\143\x6f\x6d\57\141\165\x74\150\x2f\x63\x6c\157\165\144\55\160\154\x61\x74\146\157\x72\155"; private ?HttpClient $metaDataHttpClient = null; private ?\Google_Client $gceClient = null; private ?GoogleServiceInstance $instance = null; private ?GceInstance $gceInstance = null; public function __construct() { $this->gceClient = new \Google_Client(); $this->gceClient->addScope(self::GOOGLE_APIS_SCOPE_CLOUD_PLATFORM); } public function setGceInstance(GceInstance $instance) : void { $this->gceInstance = $instance; } public function getGceInstance() : ?GceInstance { return $this->gceInstance; } public function getGceClient() : ?\Google_Client { return $this->gceClient; } public function setAuthConfig(array $config) : void { $this->gceClient->setAuthConfig($config); } public function getInstance() : ?GoogleServiceInstance { goto adb25; adb25: if (!(true === is_null($this->instance))) { goto efb3d; } goto F163f; F93b8: $service = new \Google_Service_Compute($this->gceClient); goto Cc74b; Cc74b: $this->instance = $this->retry(function () use($service, $project, $zone, $instanceId) { $instance = $service->instances->get($project, $zone, $instanceId); return $instance; }); goto ef26e; F163f: $project = $this->gceInstance->getProjectId(); goto Ebbb8; A8bc9: return $this->instance; goto Cc3e8; Bc11a: $instanceId = $this->gceInstance->getInstanceId(); goto F93b8; Ebbb8: $zone = $this->gceInstance->getZone(); goto Bc11a; ef26e: efb3d: goto A8bc9; Cc3e8: } public function getInstanceTags() : array { goto ecf63; caaa5: $tags = $instance->getTags(); goto f6c79; b5a53: return $instanceTags; goto E7633; Eaa76: $instanceTags = $tags->getItems(); goto dfbc7; f6c79: if (!(true === isset($tags) && $tags instanceof \Google_Service_Compute_Tags)) { goto Cf925; } goto Eaa76; dfbc7: Cf925: goto b5a53; ecf63: $instanceTags = []; goto c72fe; c72fe: $instance = $this->getInstance(); goto caaa5; E7633: } public function hasInstanceTag(string $name) : bool { goto e5a24; e5a24: $hasInstanceTag = false; goto Bcf3b; Bcf3b: $instanceTags = (array) $this->getInstanceTags(); goto E8318; Cd422: B669a: goto dcbe1; E8318: if (!(false === empty($instanceTags))) { goto b82f2; } goto ee94e; ee316: return $hasInstanceTag; goto b908d; dcbe1: b82f2: goto ee316; ee94e: foreach ($instanceTags as $tag) { goto F8301; E2f45: C1b5d: goto Bbd10; Bbd10: d79f8: goto C105b; E3ed5: $hasInstanceTag = true; goto e295c; F8301: if (!(false === empty($tag) && $name == $tag)) { goto C1b5d; } goto E3ed5; e295c: goto B669a; goto E2f45; C105b: } goto Cd422; b908d: } public function addInstanceTag(string $name) : void { goto B0cdd; B700f: $tags->setItems($items); goto a851d; ebdf2: $items = (array) $tags->getItems(); goto f3ed4; F0831: $tags = $instance->getTags(); goto ebdf2; b07b0: if (!(false === $hasInstanceTag)) { goto ee94a; } goto e58ef; e58ef: $instance = $this->getInstance(); goto F0831; B0cdd: $hasInstanceTag = $this->hasInstanceTag($name); goto b07b0; f3ed4: $items[] = $name; goto B700f; cf9b9: ee94a: goto B1604; a851d: $this->setInstanceTags($tags); goto cf9b9; B1604: } public function getSnapshots() : array { goto D9d10; c8f8b: $optParams["\160\141\x67\x65\x54\x6f\x6b\x65\x6e"] = null; goto Fe75a; dc115: bef62: goto C114a; ba905: foreach ($disks as $disk) { $diskSources[] = $disk->getSource(); Abc39: } goto eed10; A5c3c: D0c61: goto e72fc; D9d10: $project = $this->gceInstance->getProjectId(); goto bc6d2; dd031: $disks = (array) $instance->getDisks(); goto bb42f; f2890: if (!(true === isset($snapshotList) && $snapshotList instanceof \Google_Service_Compute_SnapshotList)) { goto C50d7; } goto A6473; F2a3e: $snapshots = []; goto Ed3a2; A8cc1: throw new \Exception("\111\156\x73\x74\x61\x6e\x63\x65\x20\144\157\145\163\40\156\157\x74\40\x65\170\x69\163\x74\56"); goto F9404; Cb394: return $snapshots; goto d7464; c4649: foreach ($snapshotListItems as $snapshotListItem) { goto Aa374; F4924: $labels = (array) $snapshotListItem->getLabels(); goto Fd0b4; Aee7a: $snapshot->setId($snapshotListItem->getId()); goto d698c; e55aa: $createdAt = new \DateTime($createdAt); goto C928d; Aa374: $snapshotListItemSourceDisk = $snapshotListItem->getSourceDisk(); goto C5252; C5252: if (!(true === in_array($snapshotListItemSourceDisk, $diskSources))) { goto E0579; } goto f5218; Fc0fd: $snapshot->setStatus($snapshotListItem->getStatus()); goto db22c; a2861: if (!(true === isset($labels["\x74\x79\160\x65"]) && $labels["\164\x79\x70\x65"] == Snapshot::TYPE_MANUAL)) { goto D8ab9; } goto c70c1; c70c1: $type = Snapshot::TYPE_MANUAL; goto d2b2b; C928d: $createdAt->setTimezone(new \DateTimeZone("\x55\x54\103")); goto F4924; Aa64b: $disk = (array) explode("\x2f", $snapshotListItemSourceDisk); goto c5a08; Fd0b4: $type = Snapshot::TYPE_AUTOMATED; goto a2861; dc1fd: $snapshot->setType($type); goto Fc0fd; C437e: $snapshot->setDiskSizeGb($snapshotListItem->getDiskSizeGb()); goto c61a5; db22c: $snapshot->setCreatedAt($createdAt); goto de10c; E175b: $snapshot->setDisk($disk); goto C437e; f5218: $createdAt = $snapshotListItem->getCreationTimestamp(); goto e55aa; a3420: d386f: goto da510; Ca4e6: $snapshot = new Snapshot(); goto Aee7a; c5a08: $disk = false === empty($disk) ? end($disk) : ''; goto Ca4e6; de10c: $snapshots[] = $snapshot; goto Ee7a6; Ee7a6: E0579: goto a3420; c61a5: $snapshot->setLabels($labels); goto dc1fd; d2b2b: D8ab9: goto Aa64b; d698c: $snapshot->setName($snapshotListItem->getName()); goto E175b; da510: } goto Bb5d5; e72fc: Dd232: goto Cb394; F9404: goto Dd232; goto a67ca; Bb5d5: fe9fe: goto E56ab; Fe75a: $snapshotList = $this->retry(function () use($service, $project, $optParams) { $snapshotList = $service->snapshots->listSnapshots($project, $optParams); return $snapshotList; }); goto f2890; eed10: Bad52: goto dc115; ca964: bd4aa: goto c8f8b; C114a: $optParams = []; goto ca964; A6473: $snapshotListItems = (array) $snapshotList->getItems(); goto c4649; bc6d2: $service = new \Google_Service_Compute($this->gceClient); goto d68f1; bb42f: if (!(false === empty($disks))) { goto bef62; } goto ba905; Ed3a2: if (true === isset($instance) && $instance instanceof \Google_Service_Compute_Instance) { goto B14b5; } goto A8cc1; d68f1: $instance = $this->getInstance(); goto F2a3e; f5f5c: C50d7: goto ab3b4; E56ab: $params["\160\141\x67\145\x54\157\153\x65\x6e"] = $snapshotList->getNextPageToken(); goto f5f5c; a67ca: B14b5: goto Ca839; Ca839: $diskSources = []; goto dd031; ab3b4: if (false === empty($optParams["\160\x61\x67\145\124\x6f\x6b\x65\156"])) { goto bd4aa; } goto A5c3c; d7464: } public function getSnapshot($id) { goto B7248; Ece8e: if (!(false === empty($snapshotListItems) && true === isset($snapshotListItems[0]))) { goto E8e06; } goto b4b4a; Ae394: $snapshotListItems = (array) $snapshotList->getItems(); goto Ece8e; b169c: $optParams = ["\146\x69\x6c\x74\145\162" => sprintf("\x69\144\75\45\163", $id)]; goto c9137; E9e20: return $snapshot; goto Df120; A6c45: if (!(true === isset($snapshotList) && $snapshotList instanceof \Google_Service_Compute_SnapshotList)) { goto e2578; } goto Ae394; fb522: $service = new \Google_Service_Compute($this->gceClient); goto Ba7ca; Ba7ca: $snapshot = null; goto b169c; c9137: $snapshotList = $this->retry(function () use($service, $project, $optParams) { $snapshotList = $service->snapshots->listSnapshots($project, $optParams); return $snapshotList; }); goto A6c45; B7248: $project = $this->gceInstance->getProjectId(); goto fb522; ae2da: e2578: goto E9e20; F252d: E8e06: goto ae2da; b4b4a: $snapshot = $snapshotListItems[0]; goto F252d; Df120: } public function deleteSnapshot($id) : GoogleServiceOperation { goto a02b0; a02b0: $project = $this->gceInstance->getProjectId(); goto ca008; Bc380: return $response; goto E1f0c; ca008: $service = new \Google_Service_Compute($this->gceClient); goto af116; af116: $response = $this->retry(function () use($service, $project, $id) { $response = $service->snapshots->delete($project, $id); return $response; }); goto Bc380; E1f0c: } public function createDiskSnapshots(string $name, string $type) : void { goto ef1c7; e5c39: $disks = (array) $instance->getDisks(); goto a826b; a826b: if (!(false === empty($disks))) { goto cf4af; } goto f15eb; Ff9b7: if (!(true === isset($instance) && $instance instanceof \Google_Service_Compute_Instance)) { goto bbd5d; } goto e5c39; bae95: A9319: goto d74e9; bf738: bbd5d: goto D4614; f15eb: foreach ($disks as $disk) { goto Ce1ea; Ce1ea: $diskSource = $disk->getSource(); goto A61dc; a2b36: cfc93: goto d0b2d; Be6de: $diskName = false === empty($diskName) ? end($diskName) : ''; goto F15e0; A61dc: $diskName = (array) explode("\x2f", $diskSource); goto Be6de; F15e0: $this->createSnapshot($name, $diskName, $type); goto a2b36; d0b2d: } goto bae95; d74e9: cf4af: goto bf738; ef1c7: $instance = $this->getInstance(); goto Ff9b7; D4614: } public function createSnapshot($name, $diskName, $type) : GoogleServiceOperation { goto Ae36d; ecc9f: $service = new \Google_Service_Compute($this->gceClient); goto c2c02; Bbd89: $name = sprintf("\x25\x73\55\45\163", $name, $dateTime->getTimestamp()); goto c850a; c850a: $name = substr(strtolower($name), 0, 60); goto Ac44f; Ae36d: $project = $this->gceInstance->getProjectId(); goto A0a08; E7573: $snapshot->setName($name); goto Bb46a; Bb46a: $snapshot->setLabels($labels); goto Fe464; A0a08: $instanceUid = $this->gceInstance->getUid(); goto f33ff; Fe464: $response = $this->retry(function () use($service, $project, $zone, $diskName, $snapshot) { $response = $service->disks->createSnapshot($project, $zone, $diskName, $snapshot); return $response; }); goto D28ef; Ac44f: $labels = ["\x63\x72\x65\141\x74\145\144\x5f\142\171" => "\x63\x6c\x6f\x75\x64\x70\141\x6e\x65\154", "\x69\156\163\164\x61\156\143\145\x5f\x75\151\144" => $instanceUid, "\164\x79\160\x65" => $type]; goto ccd61; D28ef: return $response; goto fd144; ccd61: $snapshot = new \Google_Service_Compute_Snapshot(); goto E7573; f33ff: $zone = $this->gceInstance->getZone(); goto ecc9f; c2c02: $dateTime = new \DateTime(); goto Bbd89; fd144: } public function getMetaDataInstanceId() : ?string { $instanceId = $this->getMetaDataValue("\151\x6e\x73\x74\141\x6e\143\145\x2f\151\144"); return $instanceId; } public function getMetaDataInstanceName() : ?string { $instanceName = $this->getMetaDataValue("\x69\156\x73\164\141\x6e\x63\x65\x2f\156\141\155\x65"); return $instanceName; } public function getMetaDataMachineType() : ?string { goto F50c5; ecb4e: return $machineType; goto D37c8; f4792: $machineType = array_pop($machineType); goto ecb4e; F50c5: $machineType = $this->getMetaDataValue("\x69\x6e\163\164\141\156\143\x65\57\x6d\x61\143\x68\151\x6e\145\x2d\x74\x79\160\145"); goto d5208; d5208: $machineType = explode("\x2f", $machineType); goto f4792; D37c8: } public function getMetaDataIpv4PublicIp() : ?string { $ipv4PublicIp = $this->getMetaDataValue("\151\x6e\x73\x74\x61\156\143\x65\57\x6e\x65\164\x77\x6f\162\x6b\x2d\x69\156\164\145\x72\x66\141\x63\x65\163\x2f\x30\x2f\x61\143\143\145\163\163\55\x63\x6f\x6e\146\x69\147\163\x2f\60\x2f\145\170\x74\145\162\x6e\141\x6c\55\x69\x70"); return $ipv4PublicIp; } public function getMetaDataZone() : ?string { goto Da48b; Ef2e9: return $zone; goto B707e; b5f38: $zone = array_pop($zone); goto Ef2e9; F8e88: $zone = explode("\x2f", $zone); goto b5f38; Da48b: $zone = $this->getMetaDataValue("\151\156\x73\164\141\156\143\x65\57\x7a\x6f\156\x65"); goto F8e88; B707e: } public function getMetaDataProjectId() : ?string { $projectId = $this->getMetaDataValue("\x70\162\157\x6a\x65\143\164\x2f\160\x72\157\x6a\145\143\x74\55\x69\x64"); return $projectId; } private function getMetaDataValue($path) : ?string { goto Eb97a; f52fa: $metaDataHttpClient = $this->getMetaDataHttpClient(); goto Dd1c0; D7182: $responseData = ''; goto C70e4; Dd1c0: $response = $this->retry(function () use($metaDataHttpClient, $request) { $response = $metaDataHttpClient->send($request); return $response; }); goto eddcc; d7b3c: $responseData = trim((string) $response->getBody()); goto Eb69b; Eb97a: $requestUrl = sprintf("\x25\163\57\x25\163", rtrim(self::META_DATA_ENDPOINT, "\x2f"), $path); goto d13c0; b4768: return $responseData; goto d5ec7; eddcc: $responseStatusCode = $response->getStatusCode(); goto D7182; Eb69b: b842e: goto b4768; d13c0: $request = new Request("\x47\x45\124", $requestUrl); goto f52fa; C70e4: if (!(200 == $responseStatusCode)) { goto b842e; } goto d7b3c; d5ec7: } private function getMetaDataHttpClient() : HttpClient { goto e3429; B1dd1: $this->metaDataHttpClient = new HttpClient($config); goto Ed7ac; baff0: $config = ["\x74\x69\155\145\x6f\x75\x74" => self::META_DATA_HTTP_CLIENT_TIMEOUT, "\166\145\x72\x69\146\171" => false, "\150\x65\x61\x64\x65\x72\x73" => ["\x4d\145\x74\141\144\141\x74\x61\55\x46\154\141\166\157\162" => "\x47\x6f\x6f\147\x6c\145"]]; goto B1dd1; Ed7ac: F38b4: goto f3e2b; e3429: if (!(true === is_null($this->metaDataHttpClient))) { goto F38b4; } goto baff0; f3e2b: return $this->metaDataHttpClient; goto cd93f; cd93f: } private function retry(callable $fn, $retries = 1, $delay = 3) { return Retry::retry($fn, $retries, $delay); } }
